<h1 id="chip-004-revised-block-headers">CHIP 004 Revised Block Headers</h1>

<h2 id="this-chip-is-subject-to-change">THIS CHIP IS SUBJECT TO CHANGE</h2>
<h2 id="block-headers-could-get-real-weird">BLOCK HEADERS COULD GET REAL WEIRD</h2>

<h2 id="abstract">Abstract</h2>
<p>Blocks are required to commit to a tree of state changes. This replaces Bitcoinâ€™s transaction root in the block header. An additional blockheader field is created. The new field commits to all information validating those state changes. Block height must also be committed to in the header.</p>

<h2 id="motivation">Motivation</h2>

<p>Adding additional information to the block header simplifies verification, and allows new SPV applications as well as future TXO-set optimizations. When re-examining these, we chose to logically separate them into state changes, and state change validations. Validation information can be safely discarded by most nodes after a period of time.</p>

<h2 id="specification">Specification</h2>

<p>Each block header MUST include two 32 byte fields: <code class="highlighter-rouge">hashStateChanges</code> and <code class="highlighter-rouge">hashValidations</code>. These fields represent the merkle root of trees committing to TXOs created and consumed, and the witnesses and ancillary information. The block header is constructed as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[PoSpace][PoET][signature][version][hashPrevBlock][rewardsInclusion][hashStateChanges][hashValidations][time][blockHeight][difficultyBits]
</code></pre></div></div>

<p>The <code class="highlighter-rouge">hashStateChanges</code> tree is constructed by creating a Merkle Tree from the list of all inputs consumed by the block, and the list of outputs created in the block. Each node includes additional information describing how many TXOs are created in transactions summarized by that node. As such, a proof in this tree can establish the index in the block of any TXO. Transactions are sorted lexically. Inputs are sorted to match transactions. As such there is a canonical structure for the tree.</p>

<p>The <code class="highlighter-rouge">hashValidations</code> tree is constructed by creating tuples of <code class="highlighter-rouge">(witnessInfo, witness)</code> for each input, in the same order they appear in the <code class="highlighter-rouge">hashStateChanges</code> tree. After the tuples corresponding to the inputs of a single transaction the aggregate signature for that transaction is included. This gives the tree a canonical order that intuitively matches the <code class="highlighter-rouge">hashStateChanges</code> tree.</p>

<p>The <code class="highlighter-rouge">rewardsInclusion</code> field allows the farmer to include rewards from other rewards chains, updating the head pointers to the other chains. See chip17 for more details.</p>

<p>The <code class="highlighter-rouge">signature</code> is a zero knowledge proof of knowledge of the proof of space, that also commit to and signs the rest of the block, apart from the PoET. This is described in detail in Chip 14.</p>

<p>The <code class="highlighter-rouge">PoSpace</code> and <code class="highlighter-rouge">PoET</code> are part of the trunk of the blockchain, and the rest of the block is part of the foliage of the blockchain.
The <code class="highlighter-rouge">PoET</code> is added on to the block after it is computed.</p>
